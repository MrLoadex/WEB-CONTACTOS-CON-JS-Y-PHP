<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABM (CRUD) con WebComponent - Versión 2.0</title>
    <style>
        /* Estilo global para el cuerpo del documento */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        /* Contenedor principal del componente */
        .crud-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Estilo para los botones */
        .crud-button {
            font-family: Arial, sans-serif;
            font-size: 1rem;
            padding: 10px 20px;
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .crud-button:hover {
            background-color: #45a049;
        }

        /* Estilo para la tabla */
        table {
            width: 80%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #4CAF50;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>

<div class="crud-container">
    <x-abm-crud></x-abm-crud>
</div>

<script>
    class ABMCrud extends HTMLElement {
        constructor() {
            super();

            // Crear elementos principales
            this._title = document.createElement('h2');
            this._title.innerText = 'Seleccione una opción:';

            // Botones
            this._buttonRefresh = this._createButton('Refrescar');
            // Botones de usuario
            this._buttonCreateUser = this._createButton('Crear Usuario');
            this._buttonCreateUserTeamLink = this._createButton('Vincular Uusario y Equipo');
            // Botones de Equipo
            this._buttonCreateTeam= this._createButton('Crear Equipo');
            // Botones de Accion
            this._buttonCreateAction= this._createButton('Crear Accion');
            // Botones de Equipo - Accion
            this._buttonCreateTeamActionLink= this._createButton('Vincular Equipo y Accion');

            // Tabla Usuarios
            this._user_table = document.createElement('table');
            this._user_table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre de usuario</th>
                        <th>Equipo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            // Tabla Equipo
            this._team_table = document.createElement('table');
            this._team_table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre del Equipo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            // Tabla Acciones
            this._action_table = document.createElement('table');
            this._action_table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre de la Accion</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            // Tabla Equipos_Acciones
            this._team_action_table = document.createElement('table');
            this._team_action_table.innerHTML = `
                <thead>
                    <tr>
                        <th>Equipo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

            // Agregar eventos a los botones
            this._buttonRefresh.addEventListener('click', this.listData.bind(this));
            // USUARIO
            this._buttonCreateUser.addEventListener('click', this.createUser.bind(this));
            this._buttonCreateUserTeamLink.addEventListener('click', this.createUserTeamLink.bind(this));
            // EQUIPO
            this._buttonCreateTeam.addEventListener('click', this.createTeam.bind(this));
            // ACCION
            this._buttonCreateAction.addEventListener('click', this.createAction.bind(this));
            // VINCULO ENTRE ACCION Y EQUIPO
            this._buttonCreateTeamActionLink.addEventListener('click', this.createTeamActionLink.bind(this));


            // Agregar elementos al componente
            this.appendChild(this._title);
            this.appendChild(this._buttonRefresh);
            //User elements
            this.appendChild(this._buttonCreateUser);
            this.appendChild(this._buttonCreateUserTeamLink);
            this.appendChild(this._user_table);
            // Team elements
            this.appendChild(this._buttonCreateTeam);
            this.appendChild(this._team_table);
            // Actions elements
            this.appendChild(this._buttonCreateAction);
            this.appendChild(this._action_table);
            // Teams_Actions elements
            this.appendChild(this._buttonCreateTeamActionLink);
            this.appendChild(this._team_action_table);
        }
        // Método privado para crear botones con estilos
        _createButton(label) {
            const button = document.createElement('button');
            button.innerText = label;
            button.className = 'crud-button'; // Usar la clase CSS para el estilo
            return button;
        }
        
        getTeamName(teamID) {
            return new Promise((resolve, reject) => {
                if (teamID !== null && teamID.trim() !== '') {
                    fetch(`./procesos/Teams/getTeamData.php?id=${teamID}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error en la respuesta de la red');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.error) {
                                resolve("Sin Equipo");
                            } else {
                                resolve(data.name);
                            }
                        })
                        .catch(error => {
                            console.error('Error al obtener datos del equipo:', error);
                            resolve("Sin Equipo");
                        });
                } else {
                    console.warn('Advertencia: Debe ingresar un ID de equipo válido.');
                    resolve("Sin Equipo");
                }
            });
        }
        getActionName(actionID) {
            return new Promise((resolve, reject) => {
                if (actionID !== null && actionID.trim() !== '') {
                    fetch(`./procesos/Actions/getActionName.php?id=${actionID}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error en la respuesta de la red');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            } else {
                                resolve(data.name);
                            }
                        })
                        .catch(error => {
                            console.error('Error al obtener datos del equipo:', error);
                            reject(error);
                        });
                } else {
                    const errorMsg = 'Error: Debe ingresar un ID de la accion válido.';
                    console.error(errorMsg);
                    reject(new Error(errorMsg));
                }
            });
        }

        // Método para listar datos
        listData() {
            this.listUsers();
            this.listTeams();
            this.listActions(); 
            this.listTeamsActions(); 
        }        
        listUsers() {
            // Limpiar la tabla antes de llenarla
            this._user_table.querySelector('tbody').innerHTML = '';
            // Realizar la solicitud para obtener todos los usuarios
            fetch('./procesos/contactos/listUsers.php')
            .then(response => response.json())
            .then(data => {
                    // Verificar si se recibieron datos
                    if (Array.isArray(data)) {
                        // Iterar sobre los datos y agregar filas a la tabla
                        data.forEach(user => {
                            this.getTeamName(user.ID_team)
                                .then(teamName => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${user.ID}</td>
                                        <td>${user.name}</td>
                                        <td>${teamName}</td>
                                    `;
                                    this._user_table.querySelector('tbody').appendChild(row);
                                }) 
                        });
                    } else {
                        console.error('Error: No se recibieron datos válidos.');
                    }
                })
                .catch(error => console.error('Error al cargar los datos:', error));
        }
        listTeams() {
            // Limpiar la tabla antes de llenarla
            this._team_table.querySelector('tbody').innerHTML = '';
            // Realizar la solicitud para obtener todos los usuarios
            fetch('./procesos/Teams/listTeams.php')
            .then(response => response.json())
            .then(data => {
                    // Verificar si se recibieron datos
                    if (Array.isArray(data)) {
                        // Iterar sobre los datos y agregar filas a la tabla
                        data.forEach(team => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${team.ID}</td>
                                <td>${team.name}</td>
                            `;
                            this._team_table.querySelector('tbody').appendChild(row);
                        });
                    } else {
                        console.error('Error: No se recibieron datos válidos.');
                    }
                })
                .catch(error => console.error('Error al cargar los datos:', error));
        }
        listActions() {
            // Limpiar la tabla antes de llenarla
            this._action_table.querySelector('tbody').innerHTML = '';
            // Realizar la solicitud para obtener todos los usuarios
            fetch('./procesos/Actions/listActions.php')
            .then(response => response.json())
            .then(data => {
                    // Verificar si se recibieron datos
                    if (Array.isArray(data)) {
                        // Iterar sobre los datos y agregar filas a la tabla
                        data.forEach(action => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${action.ID}</td>
                                <td>${action.name}</td>
                            `;
                            this._action_table.querySelector('tbody').appendChild(row);
                        });
                    } else {
                        console.error('Error: No se recibieron datos válidos.');
                    }
                })
                .catch(error => console.error('Error al cargar los datos:', error));
        }
        listTeamsActions() {
            // Limpiar la tabla antes de llenarla
            this._team_action_table.querySelector('tbody').innerHTML = '';
        
            // Realizar la solicitud para obtener todas las acciones de los equipos
            fetch('./procesos/Teams_Actions/listTeamsActions.php')
                .then(response => response.json())
                .then(data => {
                    // Verificar si se recibieron datos
                    if (Array.isArray(data)) {
                        // Iterar sobre los datos y agregar filas a la tabla
                        data.forEach(team_action => {
                            Promise.all([
                                this.getTeamName(team_action.ID_team),
                                this.getActionName(team_action.ID_action)
                            ])
                            .then(([teamName, actionName]) => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${teamName}</td>
                                    <td>${actionName}</td>
                                `;
                                this._team_action_table.querySelector('tbody').appendChild(row);
                            })
                            .catch(error => {
                                console.error('Error al obtener los datos:', error);
                                // Si falla la obtención del nombre del equipo o de la acción, aún agregamos la fila con los IDs
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${team_action.ID_team}</td>
                                    <td>${team_action.ID_action}</td>
                                `;
                                this._team_action_table.querySelector('tbody').appendChild(row);
                            });
                        });
                    } else {
                        console.error('Error: No se recibieron datos válidos.');
                    }
                })
                .catch(error => console.error('Error al cargar los datos:', error));
        }
        
        //////////////////////////////////////////////// METODOS DE USUARIO
        // Método para crear datos
        createUser() {
           const username = prompt('Ingrese el nombre de usuario:');
            const IDteam = prompt('Ingrese el ID del equipo al que pertenece:');

            if (username && IDteam) {
                const data = {
                    name: username,
                    ID_team: IDteam
                };

                fetch('./procesos/contactos/addUser.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        this.listData();
                    } else {
                        console.error('Error al agregar usuario:', result.error);
                    }
                })
                .catch(error => console.error('Error al agregar usuario:', error));
            } else {
                console.error('Error: Debe ingresar un nombre de usuario y un saldo válidos.');
            }
        }

        //////////////////////////////////////////////// METODOS DE EQUIPO
        // Método para crear datos
        createTeam() 
        {
            const teamname = prompt('Ingrese el nombre del Equipo:');
     
            if (teamname) {
                const data = {
                    name: teamname,
                };

                fetch('./procesos/Teams/addTeam.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        this.listData();
                    } else {
                        console.error('Error al agregar team:', result.error);
                    }
                })
                .catch(error => console.error('Error al agregar team:', error));
            } else {
                console.error('Error: Debe ingresar un nombre de team válido.');
            }
        }

        //////////////////////////////////////////////// METODOS DE ACCION
        // Método para crear datos
        createAction() {
            {
                const actionname = prompt('Ingrese el nombre de la accion');
         
                if (actionname) {
                    const data = {
                        name: actionname,
                    };
    
                    fetch('./procesos/Actions/addAction.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            this.listData();
                        } else {
                            console.error('Error al agregar la accion:', result.error);
                        }
                    })
                    .catch(error => console.error('Error al agregar la accion:', error));
                } else {
                    console.error('Error: Debe ingresar un nombre de accion válido.');
                }
            }
        }

        // Método para crear datos
        createTeamActionLink() {
            {
                const teamID = prompt('Ingrese el ID del equipo');
                const actionID = prompt('Ingrese el ID de la accion');
         
                if (teamID && actionID) {
                    const data = {
                        ID_team: teamID,    
                        ID_action: actionID,
                    };
    
                    fetch('./procesos/Teams_Actions/addTeamActionLink.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            this.listData();
                        } else {
                            console.error('Error al vincular la accion y quipo:', result.error);
                        }
                    })
                    .catch(error => console.error('Error al vincular la accion y quipo:', error));
                } else {
                    console.error('Error: Debe ingresar un nombre de accion y equipo válidos.');
                }
            }
        }
    
        createUserTeamLink()
        {
            const userID = prompt('Ingrese el ID del usuario');
            const teamID = prompt('Ingrese el ID del equipo');
            if (userID && teamID) {
                const data = {
                    userID: userID,
                    teamID: teamID,
                };
        
                fetch('./procesos/contactos/createUserTeamLink.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        console.log('Vinculación exitosa');
                    } else {
                        console.error('Error al vincular el usuario y el equipo:', result.error);
                    }
                })
                .catch(error => console.error('Error al vincular el usuario y el equipo:', error));
            } else {
                console.error('Error: Debe ingresar IDs de usuario y equipo válidos.');
            }
        }

        // Método llamado cuando el componente es conectado al DOM
        connectedCallback() {
            this.listData();
        }
    
    }

    // Definir el nuevo elemento personalizado
    customElements.define('x-abm-crud', ABMCrud);
</script>
</body>
</html>
